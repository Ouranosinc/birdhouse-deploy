#!/bin/sh
# Sync relevant data to other hosts.
#
# Useful to prepare a new replacement host or to keep a staging host up-to-date.
#
# Data specific to a host (logs, metrics, tokens, ...) are excluded.
#
# Thredds data also excluded since it is huge.
#
# Assume
# * ssh passwordless to target host is setup properly

THIS_FILE="`realpath "$0"`"
THIS_DIR="`dirname "$THIS_FILE"`"
COMPOSE_DIR="`dirname "$THIS_DIR"`"

# source default.env, else might have errors sourcing env.local
if [ -f "$COMPOSE_DIR/default.env" ]; then
    . "${COMPOSE_DIR}/default.env"
fi

if [ -f "$COMPOSE_DIR/env.local" ]; then
    # Get DATA_PERSIST_ROOT
    . "${COMPOSE_DIR}/env.local"
fi


TARGET_HOST="$1"; shift
FORCE_MODE="$1"

if [ -z "$FORCE_MODE" ]; then
    # Default to dry-run
    SYNC_DATA_EXTRA_RSYNC_OPTS="$SYNC_DATA_EXTRA_RSYNC_OPTS --dry-run"
fi


RSYNC_BASE_CMD="rsync --recursive --links --hard-links --times \
    --itemize-changes --human-readable --delete --stats \
    --progress $SYNC_DATA_EXTRA_RSYNC_OPTS"

set -x

for item in geoserver/ jupyterhub_user_data/ magpie_persist/; do
    # Assume DATA_PERSIST_ROOT is same between both hosts !
    $RSYNC_BASE_CMD $DATA_PERSIST_ROOT/$item $TARGET_HOST:$DATA_PERSIST_ROOT/$item
done
